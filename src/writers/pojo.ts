import BaseWriter from '../Writer';
import {GenericNodeVisitor, Text} from '../nodes';
import {Document, IElement, INode} from "../types";
import {Settings} from "../../gen/Settings";

const __version__ = '';
/* eslint-disable-next-line no-unused-vars */
const __docformat__ = 'reStructuredText';

/**
 * Translator class for Pojo writer
 */
class POJOTranslator extends GenericNodeVisitor {
    private level: number;
    private ancestors: any[];
    private generator: string;
    private warn: OmitThisParameter<(...args: any[]) => INode>;
    private error: OmitThisParameter<(...args: any[]) => INode>;
    private inSimple: number;
    private output: any;
    private settings: Settings;
    private fixedText: number;
    private root: any | undefined;
    /**
      * Create a POJOTranslator
      * @param {nodes.document} document - the document to translate
      */
    constructor(document: Document) {
        super(document);
        this.ancestors = [];
        this.generator = `<!-- generated by Docutils ${__version__} -->\n`;
        this.document = document;
        if (!this.document.reporter) {
            throw new Error('document has no reporter');
        }
        this.warn = this.document.reporter.warning.bind(this.document.reporter);
        this.error = this.document.reporter.error.bind(this.document.reporter);

        this.settings = document.settings;
        this.level = 0;
        this.inSimple = 0;
        this.fixedText = 0;
        this.output = {};
    }

    /* eslint-disable-next-line camelcase */
    default_visit(node: IElement | INode) {
        if ((<IElement>node).attlist) {

            const me = [node.tagname, (<IElement>node).attlist(), []];
            this.ancestors.push(me);
            this.level += 1;

        }
    }

    /* eslint-disable-next-line camelcase,no-unused-vars */
    default_departure(node: INode) {
        const me = this.ancestors.pop();
        if (this.level === 1) {
            this.root = me;
            //          console.log(JSON.stringify(me));
        } else {
            const parent = this.ancestors[this.ancestors.length - 1];
            parent[2].push(me);
        }
        this.level -= 1;
    }

    /* eslint-disable-next-line camelcase */
    visit_Text(node: Text) {
        this.ancestors[this.ancestors.length - 1][2].push(node.astext());
        //      const text = escapeXml(node.astext())
        //      this.output.push(text);
    }

    /* eslint-disable-next-line camelcase,no-unused-vars */
    depart_Text(node: Text) {
    }
}

/**
 * Writer class for POJOWriter
 */
class POJOWriter extends BaseWriter {
    private visitor: any;
    private translatorClass: any;
    /**
      * Create POJOWriter
      * @param {Object} args - Arguments, none right now
      */
    constructor() {
        super();
        this.translatorClass = POJOTranslator;
    }

    /**
     * Translate the document to plain old javascript object
     */
    translate() {
        const TranslatorClass = this.translatorClass;
        const visitor = new TranslatorClass(this.document);
        this.visitor = visitor;
        this.document!.walkabout(visitor);
        this.output = visitor.root;
    }
}
/*
POJOWriter.settingsSpec = [
    '"Docutils-js POJO" Writer Options',
    null,
    []];

 */
export default POJOWriter;
